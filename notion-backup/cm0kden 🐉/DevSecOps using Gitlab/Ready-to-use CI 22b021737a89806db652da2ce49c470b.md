# Ready-to-use CI

Created: July 9, 2025 6:34 PM

![image.png](Ready-to-use%20CI/image.png)

```yaml
stages:
    - build
    - runSAST
    - runSCA
    - runDAST

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  MAVEN_OPTS: "-Dmaven.repo.local=${CI_PROJECT_DIR}/.m2/repository"
  SBOM_DIR: "${CI_PROJECT_DIR}/target"  # Directory where SBOM will be generated
  TRIVY_CACHE_DIR: "${CI_PROJECT_DIR}/.trivy-cache"

maven-build:
  stage: build
  image: maven:eclipse-temurin
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .m2/repository
      - target/
  script:
    - mvn clean package -DskipTests=true
    - echo "SBOM files generated:"
    - ls -la ${SBOM_DIR}/CycloneDX-Sbom.*
  artifacts:
    paths:
      - target/*.jar
      - target/CycloneDX-Sbom.json  # JSON format SBOM
      - target/CycloneDX-Sbom.xml   # XML format SBOM
    expire_in: 1 week
  only:
    - merge_requests
    - master
    - develop

sonarcloud-check:
  stage: runSAST
  image: maven:eclipse-temurin
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  before_script:
    - apt-get update -qq && apt-get install -y -qq curl jq
  script: |
    mvn verify sonar:sonar -Dsonar.projectKey=${SONAR_PROJECTKEY}
    sleep 2
    echo "Starting Quality Gate Check"
    raw_response=$(curl -s -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=${SONAR_PROJECTKEY}")
    echo "Raw SonarCloud Project Status API response:"
    echo "$raw_response" | jq .
    quality_status=$(echo "$raw_response" | jq -r '.projectStatus.status')
    echo "Quality Gate Status: $quality_status"
    if [[ $quality_status == "ERROR" ]] ; then exit 1;fi

  only:
    - merge_requests
    - master
    - develop

snyk-check:
  stage: runSCA
  image:
    name: snyk/snyk:maven-3-jdk-20
    entrypoint: [ "" ]
  script:
    - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    - apt-get update && apt-get install -y nodejs && npm install -g snyk-to-html
    - snyk test --all-projects --json | snyk-to-html -o results.html
  artifacts:
    paths: [ "results.html" ]
    when: always
  allow_failure: true

trivy-sbom-scan:
  stage: runSCA
  image: 
    name: aquasec/trivy:latest
    entrypoint: [""]
  cache:
    key: "trivy-cache"
    paths:
      - .trivy-cache
  dependencies:
    - maven-build
  before_script:
    - mkdir -p ${TRIVY_CACHE_DIR}
  script:
    - mkdir -p ${TRIVY_CACHE_DIR}
    - trivy sbom --scanners vuln --format json --output trivy-sbom-report.json ${SBOM_DIR}/CycloneDX-Sbom.json
  artifacts:
    paths:
      - trivy-sbom-report.json
    expire_in: 1 week
  only:
    - merge_requests
    - master
    - develop
  allow_failure: true

#Sample DAST check
zap-check:  
  stage: runDAST  
  before_script: [ ]  
  image:  
    name: ghcr.io/zaproxy/zaproxy:latest  
    entrypoint: [ "" ]  
  variables:  
    ZAP_REPORT_DIR: /zap/wrk/  
    ZAP_REPORT: report_site.html  
  script:  
    - mkdir -p ${ZAP_REPORT_DIR}  
    - zap-baseline.py -t https://example.com -r ${ZAP_REPORT} || true  
    - cp ${ZAP_REPORT_DIR}${ZAP_REPORT} ${ZAP_REPORT}  
  artifacts:  
    when: always  
    expire_in: 1 week  
    paths:  
      - ${ZAP_REPORT}  
```